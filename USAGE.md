# 多线程优化版本使用说明

## 🚀 新功能特性

### 1. 多线程K近邻滤波
- **自动多线程**: 根据CPU核心数自动调整线程数（最多8线程）
- **智能分块**: 自动将数据分块并行处理
- **内存优化**: 避免大数据集内存溢出

### 2. 实时进度显示
- **K近邻计算进度**: 显示块处理进度和完成状态
- **离群点处理进度**: 显示点级别的处理进度
- **实时统计**: 显示当前处理的块ID和完成数量

### 3. 进程管理
- **PID文件**: 自动保存进程ID到 `.homework_pid`
- **Kill脚本**: 提供便捷的进程终止方案

## 📋 使用方法

### 运行分析程序
```bash
# 安装依赖（包含新增的tqdm）
pip install -r requirements.txt

# 运行主程序
python main.py
```

### 终止卡住的程序
```bash
# 方法1: 使用kill脚本（推荐）
bash kill.sh

# 方法2: 手动查找并终止
ps aux | grep "python.*main.py"
kill -9 <PID>
```

## 📊 性能优化详情

### 多线程优化策略
1. **线程数**: `min(CPU核心数, 8)` 
2. **块大小**: `max(1000, 点数/(线程数*4))`
3. **内存管理**: 分块处理避免一次性加载所有距离矩阵

### 进度显示信息
- **K近邻计算**: `K近邻计算进度: 45%|████▌     | 9/20 [00:30<00:24, 2.15块/s]`
- **离群点处理**: `处理离群点: 67%|██████▋   | 60470/90647 [00:12<00:06, 4523点/s]`

### 预期性能提升
- **单线程**: ~15-20分钟（90k点）
- **多线程**: ~3-5分钟（8核CPU）
- **内存使用**: 减少60-80%

## 🛠️ 故障排除

### 常见问题

1. **程序无响应**
   ```bash
   bash kill.sh  # 终止程序
   ```

2. **内存不足**
   - 减少线程数: 修改`num_threads = 4`
   - 增加块大小: 修改`chunk_size = 2000`

3. **进度条不显示**
   - 确保安装了tqdm: `pip install tqdm>=4.65.0`

4. **多线程错误**
   - 检查CPU核心数: `python -c "import multiprocessing; print(multiprocessing.cpu_count())"`

### 性能调优参数

在 `src/filters.py` 中可调整:
```python
num_threads = min(mp.cpu_count(), 8)  # 最大线程数
chunk_size = max(1000, len(valid_points) // (num_threads * 4))  # 块大小
```

## 📈 监控和日志

### 日志输出示例
```
2025-09-08 18:20:00 - filters - INFO - 开始多线程K近邻统计滤波，K=50, 阈值=3.0σ
2025-09-08 18:20:00 - filters - INFO - 进程ID: 12345
2025-09-08 18:20:00 - filters - INFO - 有效点数量: 90647
2025-09-08 18:20:00 - filters - INFO - 使用 8 个线程，每块 2841 个点
2025-09-08 18:20:00 - filters - INFO - 数据分成 32 块进行并行处理
```

### 系统资源监控
```bash
# 查看CPU使用情况
top -p $(cat .homework_pid)

# 查看内存使用
ps -o pid,vsz,rss,comm $(cat .homework_pid)
```

## 🎯 效果预期

- ✅ **实时进度显示**: 不再担心程序卡住
- ✅ **显著性能提升**: 多线程加速3-5倍
- ✅ **便捷进程管理**: 一键终止功能
- ✅ **内存优化**: 处理大数据集不溢出
- ✅ **容错处理**: 单线程失败不影响整体